SELECT * 
FROM "PROJECT1"."PUBLIC"."COFFEE_SHOP";


CREATE OR REPLACE TABLE PROJECT1.PUBLIC.COFFEE_SALES_ANALYSIS AS(

WITH cte_1 AS(
SELECT TRANSACTION_ID,
       -- DATES
       TRANSACTION_DATE,
       DAYNAME(TO_DATE(TRANSACTION_DATE))AS Day_name,
       MONTHNAME(TO_DATE(TRANSACTION_DATE)) AS Month_name,
       TO_CHAR(TO_DATE(TRANSACTION_DATE), 'yyyymm') AS Month_ID,
       (UNIT_PRICE*TRANSACTION_QTY) AS REVENUE,
       PRODUCT_ID,

       CASE
           WHEN TRANSACTION_TIME BETWEEN '06:00:00' AND '09:59:59' THEN 'Morning'
           WHEN TRANSACTION_TIME BETWEEN '10:00:00' AND '12:59:59' THEN 'Mid_Morning'
           WHEN TRANSACTION_TIME BETWEEN '13:00:00' AND '15:59:59' THEN 'Afternoon'
           WHEN TRANSACTION_TIME BETWEEN '16:00:00' AND '18:59:59' THEN 'Evening'
           ELSE 'NIGHT'
           END AS TIME_BUCKETS,
       ---GROUPS
       STORE_LOCATION,
       PRODUCT_TYPE,
       PRODUCT_CATEGORY,
       PRODUCT_DETAIL,
       

FROM "PROJECT1"."PUBLIC"."COFFEE_SHOP"

),CTE_2 AS(
SELECT *,

      CASE
      WHEN day_name NOT IN ('Sun', 'Sat') THEN 'Weekday'
      ELSE 'Weekend'
END AS day_type
FROM CTE_1
)

SELECT
COUNT(DISTINCT TRANSACTION_ID)AS number_of_transactions,
COUNT(DISTINCT PRODUCT_ID) AS NUMBER_UNIQUE_PRODUCTS,
SUM(IFNULL(revenue, 0))AS Total_Revenue,

CASE
    
    WHEN SUM(IFNULL(revenue, 0)) BETWEEN 0 AND 20 THEN 'Low spender'
    WHEN SUM(IFNULL(revenue, 0)) BETWEEN 21 AND 40 THEN 'Nice spender'
    ELSE 'Generous spender'
    END AS Spend_buckets,
   --GROUPS 
       STORE_LOCATION,
       PRODUCT_TYPE,
       PRODUCT_CATEGORY,
       PRODUCT_DETAIL,
       TIME_BUCKETS,
       DAY_TYPE,
       DAY_NAME,
       MONTH_NAME
       MONTH_ID
FROM CTE_2
GROUP BY ALL);

SELECT * FROM  PROJECT1.PUBLIC.COFFEE_SALES_ANALYSIS;
